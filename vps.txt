# Deploying NovaCard Marketplace on a VPS (with Cloudflare Domain)

These steps assume you have:
- A VPS (Ubuntu 22.04+ recommended).
- SSH access (username/password or SSH key).
- A Cloudflare-managed domain (e.g., `novacard.com`).
- PostgreSQL database credentials (managed DB or self-hosted).

---
## 1. Prepare the VPS
1. **Log in via SSH**
   ```bash
   ssh username@your_vps_ip
   ```
2. **Update packages and install dependencies**
   ```bash
   sudo apt update && sudo apt upgrade -y
   sudo apt install -y git curl build-essential nginx
   ```
3. **Install Node.js LTS (via nvm)**
   ```bash
   curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
   source ~/.bashrc
   nvm install 20
   nvm use 20
   ```
4. **Install PM2 (process manager)**
   ```bash
   npm install -g pm2
   ```

---
## 2. Clone and configure the project
1. **Clone the repo**
   ```bash
   git clone https://github.com/Loveago/novacar.git
   cd novacar
   ```
2. **Create `.env`** with production values:
   ```bash
   cat <<'EOF' > .env
   DATABASE_URL="postgresql://USER:PASSWORD@HOST:PORT/DB?schema=public"
   AUTH_SECRET="your-long-random-string"
   CARD_SECRET="your-other-long-string"
   EOF
   ```
3. **Install packages**
   ```bash
   npm install
   ```
4. **Apply migrations and seed (if needed)**
   ```bash
   npx prisma migrate deploy
   node prisma/seed.cjs   # optional, only once in fresh DB
   ```
5. **Build the app**
   ```bash
   npm run build
   ```
6. **Start with PM2**
   ```bash
   pm2 start npm --name novacar -- start
   pm2 save
   ```
   - App now runs on the default Next.js port (3000). Ensure it stays running after reboot (`pm2 startup`).

---
## 3. Configure Nginx reverse proxy
1. **Create an Nginx site file**
   ```bash
   sudo tee /etc/nginx/sites-available/novacar <<'EOF'
   server {
     listen 80;
     server_name novacard.com www.novacard.com;

     location / {
       proxy_pass http://127.0.0.1:3000;
       proxy_http_version 1.1;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection 'upgrade';
       proxy_set_header Host $host;
       proxy_cache_bypass $http_upgrade;
     }
   }
   EOF
   ```
2. **Enable the site and reload Nginx**
   ```bash
   sudo ln -s /etc/nginx/sites-available/novacar /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl reload nginx
   ```

---
## 4. Point Cloudflare DNS to the VPS
1. Log in to Cloudflare → your domain → **DNS**.
2. Add an `A` record:
   - Name: `@` (or `novacard.com`)
   - IPv4: your VPS IP (e.g., `203.0.113.45`)
   - Proxy status: **Proxied** (orange cloud) if you want Cloudflare caching/SSL; **DNS only** if you prefer direct access.
3. (Optional) Add `www` CNAME pointing to `@`.

---
## 5. Enable HTTPS (recommended)
If Cloudflare is set to **Proxied**, make sure SSL/TLS mode is **Full**. If you prefer end-to-end TLS with your server:
1. Install certbot:
   ```bash
   sudo apt install -y certbot python3-certbot-nginx
   ```
2. Run:
   ```bash
   sudo certbot --nginx -d novacard.com -d www.novacard.com
   ```
3. Certbot auto-renews; verify with `sudo systemctl status certbot.timer`.

---
## 6. Deploying updates
1. SSH into the server and pull latest changes:
   ```bash
   cd ~/novacar
   git pull origin main
   npm install
   npm run build
   pm2 restart novacar
   ```
2. If you modify Prisma schema, rerun `npx prisma migrate deploy` before restarting the app.

---
## 7. Troubleshooting
- **App not reachable**: `pm2 logs novacar` and `sudo journalctl -u nginx`.
- **Env vars missing**: ensure `.env` exists and `pm2 restart` after editing.
- **Uploads/storage**: local `/public/uploads` works on VPS because the disk persists. Make sure folder permissions allow `pm2` user to write if you enable runtime uploads.

That’s it! Your Next.js marketplace now runs on your VPS with a Cloudflare-backed domain.
