# Deploying NovaCard Marketplace on a VPS (with Cloudflare Domain)

These steps assume you have:
- A VPS (Ubuntu 22.04+ recommended).
- SSH access (username/password or SSH key).
- A Cloudflare-managed domain (e.g., `novacard.com`).
- PostgreSQL database credentials (managed DB or self-hosted).

---
## 1. Prepare the VPS
1. **Log in via SSH**
   ```bash
   ssh username@your_vps_ip
   ```
2. **Update packages and install dependencies**
   ```bash
   sudo apt update && sudo apt upgrade -y
   sudo apt install -y git curl build-essential nginx
   ```
3. **Install Node.js LTS (via nvm)**
   ```bash
   curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
   source ~/.bashrc
   nvm install 20
   nvm use 20
   ```
4. **Install PM2 (process manager)**
   ```bash
   npm install -g pm2
   ```

---
## 2. Clone and configure the project
1. **Clone the repo**
   ```bash
   git clone https://github.com/Loveago/novacar.git
   cd novacar
   ```
2. **Create `.env`** with production values:
   ```bash
   cat <<'EOF' > .env
   DATABASE_URL="postgresql://USER:PASSWORD@HOST:PORT/DB?schema=public"
   AUTH_SECRET="your-long-random-string"
   CARD_SECRET="your-other-long-string"
   NEXTAUTH_URL="https://novacard.com"
   RESEND_API_KEY="re_your_resend_api_key"
   EMAIL_FROM="NovaCard <noreply@yourdomain.com>"
   AUTO_SEED="false"
   # Optional (only if AUTO_SEED=true)
   # SEED_ADMIN_EMAIL="admin@novacard.com"
   # SEED_ADMIN_PASSWORD="Admin123!"
   # SEED_SELLER_EMAIL="seller@novacard.com"
   # SEED_SELLER_PASSWORD="Seller123!"
   EOF
   ```
3. **Install packages**
   ```bash
   npm install
   ```
4. **Apply migrations and seed (if needed)**
   ```bash
   npx prisma migrate deploy
   # Option A (recommended): one-time seed
   node prisma/seed.cjs
   # Option B: set AUTO_SEED=true in .env and restart the app once
   ```
5. **Build the app**
   ```bash
   npm run build
   ```
6. **Start with PM2**
   ```bash
   pm2 start npm --name novacar -- start
   pm2 save
   ```
   - App now runs on the default Next.js port (3000).
   - Enable boot on restart:
     ```bash
     pm2 startup
     ```

---
## 3. Configure Nginx reverse proxy
1. **Create an Nginx site file**
   ```bash
   sudo tee /etc/nginx/sites-available/novacar <<'EOF'
   server {
     listen 80;
     server_name novacard.com www.novacard.com;

     location / {
       proxy_pass http://127.0.0.1:3000;
       proxy_http_version 1.1;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection 'upgrade';
       proxy_set_header Host $host;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
       proxy_cache_bypass $http_upgrade;
     }
   }
   EOF
   ```
2. **Enable the site and reload Nginx**
   ```bash
   sudo ln -s /etc/nginx/sites-available/novacar /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl reload nginx
   ```

---
## 4. Point Cloudflare DNS to the VPS
1. Log in to Cloudflare → your domain → **DNS**.
2. Add an `A` record:
   - Name: `@` (or `novacard.com`)
   - IPv4: your VPS IP (e.g., `203.0.113.45`)
   - Proxy status: **Proxied** (orange cloud) if you want Cloudflare caching/SSL; **DNS only** if you prefer direct access.
3. (Optional) Add `www` CNAME pointing to `@`.

Recommended Cloudflare settings:
- **SSL/TLS mode:** Full (Strict)
- **Always Use HTTPS:** On
- **Automatic HTTPS Rewrites:** On

---
## 5. Enable HTTPS (recommended)
If Cloudflare is set to **Proxied**, make sure SSL/TLS mode is **Full**. If you prefer end-to-end TLS with your server:
1. Install certbot:
   ```bash
   sudo apt install -y certbot python3-certbot-nginx
   ```
2. Run:
   ```bash
   sudo certbot --nginx -d novacard.com -d www.novacard.com
   ```
3. Certbot auto-renews; verify with `sudo systemctl status certbot.timer`.

If you keep Cloudflare **Proxied** and want strict origin security without Let’s Encrypt, you can also use a **Cloudflare Origin Certificate** (installed on the VPS) + SSL/TLS set to **Full (Strict)**.

---
## 6. Firewall (recommended)
Allow only SSH, HTTP, and HTTPS:
```bash
sudo ufw allow OpenSSH
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
sudo ufw status
```

---
## 7. Deploying updates
1. SSH into the server and pull latest changes:
   ```bash
   cd ~/novacar
   git pull origin main
   npm install
   npx prisma migrate deploy
   npm run build
   pm2 restart novacar
   ```
2. If you modify Prisma schema, rerun `npx prisma migrate deploy` before restarting the app.

---
## 8. Troubleshooting
- **App not reachable**: `pm2 logs novacar` and `sudo journalctl -u nginx`.
- **Env vars missing**: ensure `.env` exists and `pm2 restart` after editing.
- **Uploads/storage**: local `/public/uploads` works on VPS because the disk persists. Make sure folder permissions allow `pm2` user to write if you enable runtime uploads.

Auth-specific checks:
- **Admin login not working**: make sure the DB was migrated + seeded.
- **If using AUTO_SEED**: set `AUTO_SEED=true`, restart once, log in, then set it back to `false`.
- **If auth errors about host**: ensure `NEXTAUTH_URL` matches your public domain (e.g. `https://novacard.com`).

That’s it! Your Next.js marketplace now runs on your VPS with a Cloudflare-backed domain.
